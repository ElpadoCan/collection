name: test stage call

on: push

concurrency: test

env:
  S3_HOST: ${{vars.S3_HOST}}
  S3_BUCKET: ${{vars.S3_TEST_BUCKET}}
  S3_FOLDER: ${{vars.S3_TEST_FOLDER}}
  S3_ACCESS_KEY_ID: ${{secrets.S3_ACCESS_KEY_ID}}
  S3_SECRET_ACCESS_KEY: ${{secrets.S3_SECRET_ACCESS_KEY}}

jobs:
  test-stage-wf:
    uses: ./.github/workflows/stage_call.yaml
    with:
      resource_id: ${{vars.TEST_PACKAGE_ID}}
      package_url: ${{vars.TEST_PACKAGE_URL}}
      S3_HOST: ${{vars.S3_HOST}}
      S3_BUCKET: ${{vars.S3_TEST_BUCKET}} # using test bucket
      S3_FOLDER: ${{vars.S3_TEST_FOLDER}}/ci # using test folder
    secrets: inherit

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip" # caching pip dependencies
      - run: pip install -r requirements.txt
      - run: black .
      - run: pyright -p pyproject.toml
      - run: pytest
      - name: export documentation
        if: ${{ github.ref == 'ref/head/main' }}
        run: pdoc . -o ./docs
      - uses: actions/upload-pages-artifact@v3
        if: ${{ github.ref == 'ref/head/main' }}
        with:
          path: docs/

  deploy:
    needs: build
    if: ${{ github.ref == 'ref/head/main' }}
    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write # to deploy to Pages
      id-token: write # to verify the deployment originates from an appropriate source

    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
